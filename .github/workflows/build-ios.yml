name: Build iOS libretro Core

on:
  workflow_dispatch:
    paths:
      - 'Core/**'
      - 'cytrus_*.cpp'
      - 'cytrus_*.h'
      - 'Makefile'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'Core/**'
      - 'cytrus_*.cpp'
      - 'cytrus_*.h'
      - 'Makefile'

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.1'

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Show available SDKs (確認のみ)
      run: xcodebuild -showsdks

    - name: Install dependencies
      run: |
        brew install cmake

    - name: Cache build artifacts
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          build
        key: ${{ runner.os }}-build-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-

    - name: Create build directory
      run: mkdir -p build

    - name: Create iOS toolchain file
      run: |
        cat > ios.toolchain.cmake << 'EOF'
        set(CMAKE_SYSTEM_NAME iOS)
        set(CMAKE_OSX_DEPLOYMENT_TARGET "13.0")
        set(CMAKE_IOS_ARCHITECTURES "arm64;x86_64")

        set(CMAKE_C_COMPILER clang)
        set(CMAKE_CXX_COMPILER clang++)

        set(CMAKE_C_FLAGS_INIT "-fPIC")
        set(CMAKE_CXX_FLAGS_INIT "-fPIC -std=c++17")

        set(CMAKE_SHARED_LIBRARY_CREATE_C_FLAGS "-shared")
        set(CMAKE_SHARED_LIBRARY_CREATE_CXX_FLAGS "-shared")

        set(CMAKE_C_COMPILER_WORKS TRUE)
        set(CMAKE_CXX_COMPILER_WORKS TRUE)
        EOF

    - name: Configure CMake for iOS
      run: |
        cd build
        cmake .. \
          -DCMAKE_SYSTEM_NAME=iOS \
          -DCMAKE_IOS_ARCHITECTURES="arm64;x86_64" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=../ios.toolchain.cmake \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_INSTALL_PREFIX=./install

    - name: Build with CMake
      run: |
        cd build
        make -j$(sysctl -n hw.ncpu)
