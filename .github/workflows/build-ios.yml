name: Build iOS libretro Core

on:
  workflow_dispatch:
    paths:
      - 'Core/**'
      - 'cytrus_*.cpp'
      - 'cytrus_*.h'
      - 'Makefile'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'Core/**'
      - 'cytrus_*.cpp'
      - 'cytrus_*.h'
      - 'Makefile'

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.1'

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Show iOS SDK version
      run: xcodebuild -showsdks | grep ios

    - name: Install dependencies
      run: |
        # Install any additional dependencies if needed
        brew install cmake
        
    - name: Cache build artifacts
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          build
        key: ${{ runner.os }}-build-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-

    - name: Create build directory
      run: mkdir -p build

    - name: Configure CMake for iOS
      run: |
        cd build
        cmake .. \
          -DCMAKE_SYSTEM_NAME=iOS \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
          -DCMAKE_IOS_ARCHITECTURES="arm64;x86_64" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=../ios.toolchain.cmake \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_INSTALL_PREFIX=./install

    - name: Build with CMake
      run: |
        cd build
        make -j$(sysctl -n hw.ncpu)

    - name: Build with Make (alternative method)
      if: failure()
      run: |
        # Fallback to traditional Makefile build
        make clean || true
        make PLATFORM=ios ARCH=arm64 CC=clang CXX=clang++ \
          CFLAGS="-arch arm64 -mios-version-min=13.0 -O3" \
          CXXFLAGS="-arch arm64 -mios-version-min=13.0 -O3 -std=c++17" \
          LDFLAGS="-arch arm64 -mios-version-min=13.0 -shared"

    - name: Create iOS toolchain file
      run: |
        cat > ios.toolchain.cmake << 'EOF'
        set(CMAKE_SYSTEM_NAME iOS)
        set(CMAKE_OSX_DEPLOYMENT_TARGET "13.0")
        set(CMAKE_IOS_ARCHITECTURES "arm64;x86_64")
        
        # Set compilers
        set(CMAKE_C_COMPILER clang)
        set(CMAKE_CXX_COMPILER clang++)
        
        # Set flags
        set(CMAKE_C_FLAGS_INIT "-fPIC")
        set(CMAKE_CXX_FLAGS_INIT "-fPIC -std=c++17")
        
        # Set shared library flags
        set(CMAKE_SHARED_LIBRARY_CREATE_C_FLAGS "-shared")
        set(CMAKE_SHARED_LIBRARY_CREATE_CXX_FLAGS "-shared")
        
        # Skip trying to compile test programs
        set(CMAKE_C_COMPILER_WORKS TRUE)
        set(CMAKE_CXX_COMPILER_WORKS TRUE)
        EOF

    - name: Build core using libretro-super method
      run: |
        # Create libretro build script
        cat > build-cytrus-ios.sh << 'EOF'
        #!/bin/bash
        
        set -e
        
        # Configuration
        CORE_NAME="cytrus"
        PLATFORM="ios-arm64"
        DIST_DIR="dist/${PLATFORM}"
        
        # Create directories
        mkdir -p "${DIST_DIR}"
        
        # Build flags
        export CFLAGS="-arch arm64 -mios-version-min=13.0 -O3 -fPIC"
        export CXXFLAGS="-arch arm64 -mios-version-min=13.0 -O3 -fPIC -std=c++17"
        export LDFLAGS="-arch arm64 -mios-version-min=13.0 -shared"
        export CC=clang
        export CXX=clang++
        
        # Build
        echo "Building ${CORE_NAME} for ${PLATFORM}..."
        
        # Build using Makefile
        make clean || true
        make -j$(sysctl -n hw.ncpu)
        
        # Check if build succeeded
        if [ -f "${CORE_NAME}_libretro.dylib" ]; then
          echo "Build successful!"
          cp "${CORE_NAME}_libretro.dylib" "${DIST_DIR}/"
          
          # Get library info
          file "${DIST_DIR}/${CORE_NAME}_libretro.dylib"
          otool -L "${DIST_DIR}/${CORE_NAME}_libretro.dylib"
        else
          echo "Build failed!"
          exit 1
        fi
        EOF
        
        chmod +x build-cytrus-ios.sh
        ./build-cytrus-ios.sh

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: cytrus-ios-libretro-core
        path: |
          dist/ios-arm64/*.dylib
          dist/ios-arm64/*.info
        retention-days: 30

    - name: Generate build summary
      run: |
        echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Platform: iOS (arm64)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "dist/ios-arm64/cytrus_libretro.dylib" ]; then
          echo "✅ Build successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files created:" >> $GITHUB_STEP_SUMMARY
          echo "- \`cytrus_libretro.dylib\` - Main core library" >> $GITHUB_STEP_SUMMARY
          echo "- \`cytrus_libretro.info\` - Core information file" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Library information:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          file dist/ios-arm64/cytrus_libretro.dylib >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Build failed!" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Create release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/ios-arm64/*.dylib
          dist/ios-arm64/*.info
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
